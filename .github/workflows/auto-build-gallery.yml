name: Auto Build Gallery

# Trigger workflow on push to main branch or manual run
on:
  workflow_dispatch:  # allows manual run from GitHub
  push:
    branches: [ main ]
    paths:
      - 'gallery/**'   # only trigger if gallery folder changes

jobs:
  build-gallery:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout this repo (the submodule repo)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3️⃣ Generate gallery.json
      - name: Build gallery.json
        run: |
          mkdir -p scripts
          cat <<'EOF' > scripts/build-gallery.mjs
          import fs from 'fs';
          import path from 'path';

          const root = './gallery';
          const out = './gallery.json';

          const folders = [];
          const images = [];

          function scan(dir, base = '') {
            for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
              const full = path.join(dir, entry.name);
              const rel = path.join(base, entry.name).replace(/\\/g, '/');

              if (entry.isDirectory()) {
                const cover = ['cover.jpg','cover.png','folder.jpg'].find(f =>
                  fs.existsSync(path.join(full, f))
                );
                folders.push({ name: entry.name, preview: cover ? rel + '/' + cover : null });
                scan(full, rel);  // recursive for nested folders
              } else if (/\.(png|jpe?g|gif|webp)$/i.test(entry.name)) {
                images.push({ name: entry.name, path: rel });
              }
            }
          }

          scan(root);

          fs.writeFileSync(out, JSON.stringify({ folders, images }, null, 2));
          console.log('✅ gallery.json created with', folders.length, 'folders and', images.length, 'images.');
          EOF

          node scripts/build-gallery.mjs

      # 4️⃣ Commit and push gallery.json
      - name: Commit gallery.json
        run: |
          git config user.name "AutoGallery"
          git config user.email "actions@github.com"
          git add gallery.json
          git diff --cached --quiet || git commit -m "Auto-update gallery.json"
          git push
