name: Auto Build Gallery

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/MyOS-Gallery-App/gallery/**'

jobs:
  build-gallery:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build gallery.json
        run: |
          mkdir -p apps/MyOS-Gallery-App/scripts
          cat <<'EOF' > apps/MyOS-Gallery-App/scripts/build-gallery.mjs
          import fs from 'fs';
          import path from 'path';

          const root = './apps/MyOS-Gallery-App/gallery';
          const out = './apps/MyOS-Gallery-App/gallery.json';

          function scan(dir, base = '') {
            const folders = [];
            const images = [];
            for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
              const full = path.join(dir, entry.name);
              const rel = path.join(base, entry.name).replace(/\\/g, '/');
              if (entry.isDirectory()) {
                const cover = ['cover.jpg', 'cover.png', 'folder.jpg']
                  .find(f => fs.existsSync(path.join(full, f)));
                folders.push({
                  name: entry.name,
                  preview: cover ? rel + '/' + cover : null
                });
              } else if (/\.(png|jpe?g|gif|webp)$/i.test(entry.name)) {
                images.push({ name: entry.name, path: rel });
              }
            }
            return { folders, images };
          }

          const data = scan(root);
          fs.writeFileSync(out, JSON.stringify(data, null, 2));
          console.log('âœ… Gallery JSON built with', data.folders.length, 'folders and', data.images.length, 'images.');
          EOF

          node apps/MyOS-Gallery-App/scripts/build-gallery.mjs

      - name: Commit and push updates
        run: |
          git config user.name "AutoGallery"
          git config user.email "actions@github.com"
          git add apps/MyOS-Gallery-App/gallery.json
          git diff --cached --quiet || git commit -m "Auto-update gallery.json"
          git push
